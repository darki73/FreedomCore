var Blog = {
    config: {},
    loadMoreButton: "",
    loadedContentPage: 1,
    lastPageLoaded: false,
    init: function(a) {
        Blog.config = $.extend({}, {
            loadMore: false,
            loadMorePath: "",
            loadMoreArticleTarget: "",
            loadMoreArticleType: "blog",
            loadMoreArticleLimit: ""
        }, a);
        Blog.initEvents();
    },
    initEvents: function() {
        $("#blog a.lightbox").on("click", function() {
            var a = $(this).attr("href");
            Lightbox.loadImage([{
                src: a
            }]);
            return false;
        });
        Core.bindTrackEvent("a.featured-news-link");
        if (Blog.config.loadMore) {
            Blog.loadMoreButton = $("#load-more");
            Blog.loadMoreButton.on("click", function() {
                if (!Blog.lastPageLoaded) {
                    $(this).addClass("loading");
                    Blog.loadMoreArticles(Blog.config.loadMorePath, Blog.config.loadMoreArticleTarget,
                        Blog.config.loadMoreArticleType, Blog.loadedContentPage + 1);
                }
            });
        }
    },
    loadMoreArticles: function(d, a, b, c) {
        $.ajax({
            url: d,
            type: "GET",
            dataType: "html",
            cache: true,
            global: false,
            data: {
                page: c,
                articleType: b
            },
            success: function(f) {
                if ($.trim(f) !== "") {
                    Blog.loadedContentPage++;
                    $(a).append(f);
                    if (Blog.config.loadMoreArticleLimit) {
                        var e = $(f).data("article-count");
                        if (!e || e < Blog.config.loadMoreArticleLimit) {
                            Blog.lastPageLoaded = true;
                            Blog.loadMoreButton.fadeOut();
                        }
                    }
                } else {
                    Blog.lastPageLoaded = true;
                    Blog.loadMoreButton.fadeOut();
                }
            },
            error: function() {
                Blog.loadMoreButton.addClass("disabled");
            },
            complete: function() {
                Blog.loadMoreButton.removeClass("loading");
            }
        });
    }
};
var Comments = {
    key: null,
    sig: null,
    count: 0,
    wrapper: null,
    replyForm: null,
    replyInput: null,
    replyId: null,
    collection: null,
    throttleTimer: null,
    defaultCommentSort: "best",
    commentSortCookie: "discussion.sort",
    initialize: function(b, d) {
        var e = $("#comments"),
            c = $(document);
        Comments.key = b;
        Comments.sig = d;
        Comments.wrapper = e;
        if (e.length && b && d) {
            var a = Cookie.read(Comments.commentSortCookie);
            Comments.loadBase(1, null, a);
        }
        c.delegate("#comments a.body-read", "click", Comments.moreLess);
        c.delegate("#comments .ui-pagination a", "click", Comments.loadPage);
        c.delegate("#comments .ui-pagination .page-next", "click", Comments.loadPage);
        c.delegate("#comments .ui-pagination .page-prev", "click", Comments.loadPage);
        c.delegate("#comments #comments-sorting-tabs .menu-best a", "click",
            function(f) {
                f.preventDefault();
                if (!$(this).hasClass("tab-active")) {
                    Comments.switchSortOrder("best");
                }
            });
        c.delegate("#comments #comments-sorting-tabs .menu-latest a", "click",
            function(f) {
                f.preventDefault();
                if (!$(this).hasClass("tab-active")) {
                    Comments.switchSortOrder("latest");
                }
            });
        if (Core.isIE(6)) {
            c.delegate("#comments .comments-list li", {
                mouseover: function() {
                    $(this).addClass("tile-hover");
                },
                mouseout: function() {
                    $(this).removeClass("tile-hover");
                }
            });
        }
    },
    switchSortOrder: function(a) {
        Cookie.create(Comments.commentSortCookie, a, {
            expires: 8760,
            path: "/"
        });
        Comments.loadBase(1, null, a);
    },
    add: function(c, g, h) {
        c = $(c);
        c.addClass("disabled").attr("disabled", "disabled");
        var e = c.parentsUntil("form").parent(),
            d = e.find("textarea"),
            b = e.find(".comments-error-form");
        b.find("li").hide();
        if (Comments.validate(e)) {
            var a = new Date();
            a = a.getTime();
            var f = {
                detail: $.trim(d.val()),
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                base: false,
                nocache: a
            };
            if (g && Comments.collection) {
                f.replyCommentId = Comments.replyId;
            }
            $.ajax({
                url: Core.baseUrl + "/discussion/" + Comments.key + "/comment.json",
                type: "POST",
                data: f,
                dataType: "json",
                success: function(i) {
                    d.val("");
                    c.removeClass("disabled").removeAttr("disabled");
                    Comments.cancelReply();
                    if (i.commentId) {
                        if (!g) {
                            Comments.loadBase(1, h, "latest");
                        } else {
                            Comments.loadBase(1, h);
                        }
                    } else {
                        Comments.showErrors(b, i.errors || ["throttled"]);
                        c.removeClass("disabled").removeAttr("disabled");
                    }
                },
                error: function(i) {
                    alert(JSON.stringify(i));
                    Comments.showErrors(b, ["unknown"]);
                    c.removeClass("disabled").removeAttr("disabled");
                }
            });
        } else {
            Comments.showErrors(b, ["required"]);
            c.removeClass("disabled").removeAttr("disabled");
        }
        return false;
    },
    decrement: function() {
        var b = $("#comments-total"),
            a = parseInt(b.text());
        b.text(a - 1);
    },
    increment: function() {
        var b = $("#comments-total"),
            a = parseInt(b.text());
        b.text(a + 1);
    },
    reply: function(a, d, b) {
        if (Comments.throttleTimer !== null) {
            return;
        }
        var c = $("#post-" + a);
        if (a === Comments.replyId) {
            c.next().toggle();
            return;
        }
        Comments.cancelReply();
        Comments.collection = d;
        Comments.replyId = a;
        $("#comments li.nested-reply").remove();
        $("<li/>").addClass("nested-reply").append(Comments.replyForm).insertAfter(
            c);
        Comments.replyInput.focus().val("@" + b + ": ");
    },
    cancelReply: function() {
        Comments.replyId = null;
        Comments.collection = null;
        Comments.replyForm.detach();
        Comments.replyInput.val("");
        return false;
    },
    toggleDelete: function(a) {
        $("#post-" + a).find(".comment-foot").toggle().toggleClass("visible");
    },
    remove: function(b) {
        var a = new Date();
        a = a.getTime();
        $.ajax({
            url: Core.baseUrl + "/discussion/comment/" + b + "/delete.json",
            type: "POST",
            data: {
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                nocache: a
            },
            dataType: "json",
            success: function(c) {
                if (c.success) {
                    Marketing.trackActivity("Comments", "Delete Comment");
                    $("#post-" + b).fadeOut("normal", function() {
                        $(this).remove();
                        Comments.decrement();
                    });
                }
            }
        });
    },
    loadBase: function(c, d, b) {
        var a = new Date();
        a = a.getTime();
        c = c || 1;
        b = b || Core.getHash() || Cookie.read("discussion.sort") || Comments.defaultCommentSort;
        $.ajax({
            url: Core.baseUrl + "/discussion/" + Comments.key + "/load.json",
            type: "GET",
            data: {
                page: c,
                base: true,
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                nocache: a,
                view: b
            },
            dataType: "html",
            success: function(e) {
                var f = $(e),
                    g = Comments.wrapper;
                f.insertBefore(g);
                g.remove();
                Comments.wrapper = f;
                Comments.replyForm = $("#comments-reply-form").detach().show();
                Comments.replyInput = Comments.replyForm.find("textarea");
                ReportPost.initialize(f, "comments");
                if (Core.isCallback(d)) {
                    d();
                }
            },
            error: function(e) {
                Comments.wrapper.addClass("comments-error").find(".subheader-2").toggleClass(
                    "hide");
            }
        });
    },
    loadPage: function(h) {
        h.preventDefault();
        h.stopPropagation();
        var b = new Date();
        b = b.getTime();
        var c = Core.getHash() || Cookie.read("discussion.sort") || Comments.defaultCommentSort;
        var d = $(h.currentTarget),
            g = parseInt(d.text()) || parseInt(d.data("pagenum")) || 1,
            f = $("#comments-" + g),
            a = Comments.wrapper.find(".comments-pages");
        $.ajax({
            url: Core.baseUrl + "/discussion/" + Comments.key + "/load.json",
            type: "GET",
            data: {
                page: g,
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                base: false,
                nocache: b,
                view: c
            },
            dataType: "html",
            success: function(e) {
                if (e) {
                    Marketing.trackActivity("Comments", "Load Page#" + g);
                    $("#comments-list-wrapper").html(e);
                    ReportPost.initialize($("#comments"), "comments");
                }
            }
        });
    },
    purge: function(b, c) {
        if (!confirm(c)) {
            return false;
        }
        $(b).addClass("disabled").attr("disabled", "disabled");
        var a = new Date();
        a = a.getTime();
        $.ajax({
            url: Core.baseUrl + "/discussion/" + Comments.key + "/purge.json",
            type: "POST",
            data: {
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                nocache: a
            },
            dataType: "json",
            success: function() {
                Comments.loadBase();
            }
        });
    },
    poll: function() {
        var a = new Date();
        a = a.getTime();
        $.ajax({
            url: Core.baseUrl + "/discussion/" + Comments.key + "/poll.json",
            type: "GET",
            data: {
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                nocache: a
            },
            dataType: "json",
            success: function(b) {
                if (b.count && b.count > Comments.count) {
                    var d = b.count - Comments.count,
                        c = $("#comments-pull");
                    c.find(".pull-single, .pull-multiple").hide();
                    c.find(".pull-" + (d === 1 ? "single" : "multiple")).show().find(
                        "span").text(d);
                    c.slideDown();
                }
            }
        });
    },
    lock: function(b) {
        $(b).addClass("disabled").attr("disabled", "disabled");
        var a = new Date();
        a = a.getTime();
        $.ajax({
            url: Core.baseUrl + "/discussion/" + Comments.key + "/toggleLock.json",
            type: "POST",
            data: {
                sig: Comments.sig,
                xstoken: Cookie.read("xstoken"),
                nocache: a
            },
            dataType: "json",
            success: function() {
                Comments.loadBase();
            }
        });
    },
    moreLess: function(c) {
        c.stop();
        var a = $(this),
            b = a.parent();
        b.hide();
        b.siblings().show();
        return false;
    },
    showErrors: function(c, d) {
        for (var b = 0, a = d.length; b < a; b++) {
            c.find(".error-" + d[b]).show();
        }
    },
    throttle: function(b) {
        var a = Math.ceil(b / 1000),
            d = $("#comments .comments-throttler"),
            c = $("#comments .comments-action");
        if (d.length && a <= 60) {
            d.find(".throttle-time").text(60 - a);
            d.show();
            c.hide();
            $(".reply-button").attr("data-tooltip", Msg.cms.throttleError).addClass(
                "disabled");
            clearTimeout(Comments.throttleTimer);
            Comments.throttleTimer = setTimeout(function() {
                Comments.countdown(d, c);
            }, 1000);
        }
    },
    countdown: function(d, a) {
        var b = parseInt(d.eq(0).find(".throttle-time").text()) || 60,
            c = b - 1;
        clearTimeout(Comments.throttleTimer);
        if (c <= 0) {
            Comments.throttleTimer = null;
            d.hide();
            a.show();
            $(".reply-button").removeAttr("data-tooltip").removeClass("disabled");
        } else {
            d.find(".throttle-time").text(c);
            Comments.throttleTimer = setTimeout(function() {
                Comments.countdown(d, a);
            }, 1000);
        }
    },
    updateHistory: function(a) {
        History.push({
            key: Comments.key,
            sig: Comments.sig,
            page: a
        }, "?page=" + a + "#comments");
    },
    updatePagination: function(a) {
        Comments.wrapper.find(".ui-pagination").each(function() {
            $(this).find("li").removeClass("current").eq(a - 1).addClass("current");
        });
    },
    unbury: function(a) {
        $("#post-" + a).removeClass("comment-buried");
    },
    validate: function(a) {
        return ($.trim(a.find("textarea").val()) !== "");
    }
};
"use strict";
var BML = {
    container: null,
    textarea: null,
    toolbar: null,
    commands: [{
        type: "bold",
        tag: "b",
        open: "<strong>",
        close: "</strong>",
        filter: true
    }, {
        type: "italics",
        tag: "i",
        open: "<em>",
        close: "</em>",
        filter: true
    },{
        type: "underline",
        tag: "u",
        open: '<span class="underline">',
        close: "</span>",
        filter: true
    }, {
        type: "list",
        tag: "ul",
        open: "<ul>",
        close: "</ul>",
        filter: true
    }, {
        type: "listItem",
        tag: "li",
        open: "<li>",
        close: "</li>",
        filter: true
    }, {
        type: "code",
        tag: "code",
        open: "<code>",
        close: "</code>",
        filter: true
    }, {
        type: "quote",
        tag: "quote",
        filter: true,
        pattern: ['\\[quote="(.*?)"\\]', "\\[quote\\]", "\\[\\/quote\\]"],
        result: ["<blockquote><strong>$1:</strong><br />", "<blockquote>",
            "</blockquote>"
        ]
    }],
    initialize: function(a, b) {
        BML.container = $(a);
        BML.textarea = BML.container.find("textarea");
        if (b) {
            BML.addCommands([{
                type: "url",
                tag: "url",
                filter: true,
                prompt: Msg.bml.urlPrompt,
                pattern: ["\\[url\\](.*?)\\[\\/url\\]",
                    '\\[url="(.*?)"\\](.*?)\\[\\/url\\]'
                ],
                result: ['<a href="$1">$1</a>', '<a href="$1">$2</a>']
            }]);
        }
        BML.buildToolbar();
        BML.contextQuotes();
    },
    addCommands: function(a) {
        BML.commands = BML.commands.concat(a);
    },
    append: function(a) {
        var b = BML.textarea.val();
        if (b !== "") {
            b += "\n\n";
        }
        BML.textarea.val(b + a);
    },
    buildToolbar: function() {
        BML.toolbar = $("<div/>").addClass("bml-toolbar").html(" ").prependTo(BML.container);
        $.each(BML.commands, function(a, b) {
            if (b.regions && $.inArray(Core.region, b.regions) === -1) {
                return true;
            }
            var c = Msg.bml[b.type] || "";
            $('<button type="button"/>').addClass("bml-" + b.type).html(c).bind({
                click: function() {
                    BML.insertTag(b);
                },
                mouseover: function() {
                    if (c !== "") {
                        Tooltip.show(this, c, {
                            location: "topCenter"
                        });
                    }
                }
            }).appendTo(BML.toolbar);
        });
    },
    contextQuotes: function() {
        $(document).click(function() {
            if (BML.selection() === "") {
                $(".quote-button").remove();
            }
        });
        $("#post-list").delegate(".post-detail", "mouseup", function(b) {
            var a = BML.selection();
            $(".quote-button").remove();
            if (a !== "") {
                var c = $(this).parents(".topic-post").data("post-id");
                $('<button type="button"/>').html(
                    '<span class="button-left"><span class="button-right">' + Msg.bml.quote +
                    "</span></span>").addClass("ui-button button2 quote-button").appendTo(
                    "body").click(function() {
                        BML.quote(a, c);
                        $(this).remove();
                        window.location = "#new-post";
                    }).css({
                        top: (b.pageY + 10),
                        left: (b.pageX + 10),
                        position: "absolute"
                    });
            }
        });
    },
    encode: function(a) {
        return a.replace(/&/gi, "&amp;").replace(/</gi, "&lt;").replace(/>/gi,
            "&gt;");
    },
    insertTag: function(h) {
        var d = BML.textarea[0],
            g, c, a = h.tag,
            f, b = ["", ""];
        if (h.prompt) {
            var e = prompt(h.prompt);
            if (e) {
                b[0] = e;
                b[1] = '="' + e + '"';
            } else {
                return;
            }
        }
        if (h.selfClose) {
            f = "[" + a + b[1] + " /]";
        } else {
            f = "[" + a + "]" + b[0] + "[/" + a + "]";
        } if (Core.isIE() || $.browser.msie) {
            c = document.selection.createRange().text;
            if (c !== "" && !h.selfClose) {
                document.selection.createRange().text = "[" + a + b[1] + "]" + c + "[/" +
                a + "]";
            } else {
                g = BML.textarea.val() + " " + f;
            }
        } else {
            c = {
                value: d.value.substring(d.selectionStart, d.selectionEnd),
                start: d.selectionStart,
                end: d.selectionEnd
            };
            if (c.value !== "" && d.setSelectionRange && !h.selfClose) {
                g = d.value.substring(0, c.start) + "[" + a + b[1] + "]" + d.value.substring(
                    c.start, c.end) + "[/" + a + "]" + d.value.substring(c.end, d.value.length);
            } else {
                g = BML.textarea.val() + " " + f;
            }
        } if (g) {
            BML.textarea.val(g);
        }
    },
    preview: function(a, b, c) {
        $.ajax({
            dataType: "json",
            data: {
                post: a,
                xstoken: Cookie.read("xstoken")
            },
            type: "POST",
            url: Core.baseUrl + "/forum/topic/post/preview",
            global: false,
            success: function(e, d, f) {
                $(b).append(e.detail);
                if (Core.isCallback(c)) {
                    c();
                }
            },
            error: function(f, d, e) {
                if (d === "parsererror") {
                    Core.goTo("/account-status", true);
                } else {
                    if (d === "error" && !f.getAllResponseHeaders()) {
                        Login.openOrRedirect();
                    }
                }
            }
        });
    },
    quote: function(c, b) {
        var a = '[quote="' + b + '"]';
        a += $.trim(c);
        a += "[/quote]";
        BML.append(a);
    },
    selection: function() {
        var a;
        if (window.getSelection) {
            a = window.getSelection().toString();
        } else {
            a = document.selection.createRange().text;
        }
        return a;
    },
    toHtml: function(c) {
        if (!c) {
            c = BML.textarea.val();
        }
        c = BML.encode(c);
        for (var b = 0; b < BML.commands.length; ++b) {
            var d = BML.commands[b];
            if (d.filter) {
                if (d.pattern && d.result) {
                    for (var a = 0; a < d.pattern.length; ++a) {
                        c = c.replace(new RegExp(d.pattern[a], "gi"), d.result[a]);
                    }
                } else {
                    c = c.replace(new RegExp("\\[" + d.tag + "\\]", "gi"), d.open);
                    c = c.replace(new RegExp("\\[\\/" + d.tag + "\\]", "gi"), d.close);
                }
            }
            if (d.callback && BML[d.callback]) {
                c = BML[d.callback](c, d);
            }
        }
        c = c.replace(/\n/gi, "<br />");
        c = c.replace(/\r/gi, "<br />");
        c = c.replace(/<ul><br(.*?)>/gim, "<ul>");
        c = c.replace(/<\/li><br(.*?)>/gim, "</li>");
        return c;
    }
};
if (!Object.keys) {
    Object.keys = function(c) {
        if (c !== Object(c)) {
            throw new TypeError("Object.keys called on a non-object");
        }
        var b = [],
            a;
        for (a in c) {
            if (Object.prototype.hasOwnProperty.call(c, a)) {
                b.push(a);
            }
        }
        return b;
    };
}
var Forums = {
    wrapper: null,
    initialize: function(b, a) {
        Forums.wrapper = $(b);
        Forums.bindEvents();
        Forums.setTopicsLastViewedPost(a);
    },
    bindEvents: function() {
        $(".topic-title", Forums.wrapper).on("click", function() {
            $(this).parent().parent().addClass("read");
        });
    },
    setTopicsLastViewedPost: function(m) {
        var f = "forum." + m,
            c = Satchel.get("forum." + m),
            n = $(".last-read-post"),
            e = c && c.topic ? Object.keys(c.topic) : [],
            j = null,
            d = null,
            a = null,
            k = null,
            b = null;
        for (var h = 0, g = e.length; h < g; h++) {
            j = e[h];
            k = n.filter("[data-topic-id=" + e[h] + "]");
            if (!k.length) {
                continue;
            }
            d = k.data("topic-last-posted");
            a = k.data("topic-replies");
            b = k.attr("href").split("#")[0];
            if (a > c.topic[j].replies) {
                k.addClass("new-activity").removeClass("hidden").attr("href", b + "#" + a);
            }
        }
        return Satchel.set(f, c);
    }
};
var ReportPost = {
    contextWrapper: null,
    formWrapper: null,
    offensiveId: null,
    offensiveAuthor: null,
    initialize: function(b, a) {
        if (typeof wrapperId === "string") {
            ReportPost.contextWrapper = $(wrapperId);
        } else {
            ReportPost.contextWrapper = b;
        }
        ReportPost.formWrapper = $("#report-post");
        ReportPost.offensiveId = $("#offensive-post-id");
        ReportPost.offensiveAuthor = $("#offensive-post-author");
        ReportPost.reportReason = $("#report-detail");
        ReportPost.reportSuccess = $("#report-success");
        ReportPost.postType = a;
        ReportPost.bindEvents();
    },
    bindEvents: function() {
        $("a[data-vote-type='up']", ReportPost.contextWrapper).on("click", function() {
            ReportPost.ratePost(this);
        });
        $("a[data-vote-type='down']", ReportPost.contextWrapper).on("click",
            function() {
                ReportPost.ratePost(this);
            });
        $("a[data-vote-type='report']", ReportPost.contextWrapper).on("click",
            function() {
                ReportPost.openReportForm(this);
            });
        $(".ui-button.solution-toggle", ReportPost.contextWrapper).on("click",
            function(a) {
                ReportPost.toggleSolution(this, a);
            });
        $(".report-submit", ReportPost.formWrapper).on("click", ReportPost.submitReport);
        $(".cancel-report", ReportPost.formWrapper).on("click", ReportPost.cancelReport);
    },
    ratePost: function(d) {
        d = $(d);
        var a = d.data("post-id");
        var b = d.data("vote-type");
        var e = d.data("report-type");
        var c = Core.baseUrl;
        if (ReportPost.postType === "comments") {
            c += "/discussion/comment/";
        } else {
            c += "/forum/topic/post/";
        }
        c += (a + "/" + b);
        $.ajax({
            type: "POST",
            url: c,
            data: {
                voteValue: e,
                xstoken: Cookie.read("xstoken")
            },
            success: function(f) {
                if (f.vote > 0) {
                    d.addClass("keep-shown").parents(".rate-post-wrapper").addClass(
                        "upvoted").removeClass("downvoted");
                } else {
                    if (f.vote < 0) {
                        d.parents(".rate-option").addClass("keep-shown").parents(
                            ".rate-post-wrapper").addClass("downvoted").removeClass("upvoted");
                    } else {
                        $(".keep-shown").removeClass("keep-shown");
                        d.parents(".rate-post-wrapper").removeClass("downvoted").removeClass(
                            "upvoted");
                    }
                } if (b === "down") {
                    d.parents(".downvote-menu").hide();
                }
            },
            error: function(h, f, g) {
                if (b === "down") {
                    d.parents(".downvote-menu").hide();
                }
                if (h.statusText.length === 0) {
                    Core.goTo(window.location + "?login");
                    return false;
                }
                Overlay.open(h.statusText);
            }
        });
    },
    toggleSolution: function(h, g) {
        g.preventDefault();
        var e = {},
            f = $(".solution-toggle"),
            c, b, d, a;
        h = h.jquery ? h : $(h);
        e.id = h.data("post-id");
        e.isSolved = h.hasClass("is-solution") ? true : false;
        e.container = h.closest(".topic-post");
        e.containers = $(".topic-post");
        e.content = $(".post-detail", e.container);
        e.optionsContainer = $(".post-options", e.container);
        e.solutionMarker = $(".solution-marker", e.container).length ? $(
            "solution-marker", e.container) : null;
        e.solutionLabel = $(".solution-label", e.container).length ? $(
            ".solution-label", e.container) : null;
        e.solutionLink = $(".solution-link", e.container).length ? $(
            ".solution-link", e.container) : null;
        markedSolutionText = e.optionsContainer.data("marked-as-solution-text");
        b = e.optionsContainer.data("solution-text");
        d = e.optionsContainer.data("mark-solution-text");
        a = e.optionsContainer.data("solution-link-text");
        if (!e.solutionMarker) {
            e.solutionMarker = $("<div>").addClass("solution-marker");
            e.solutionLabel = $("<span>").addClass("solution-label");
            e.solutionLabelText = $("<span>").addClass("label-text").text(
                markedSolutionText);
            e.solutionCheckmark = $("<span>").addClass("label-checkmark");
            e.solutionLabel.append(e.solutionLabelText).append(e.solutionCheckmark);
            e.solutionMarker.append(e.solutionLabel);
        }
        if (!e.solutionLink) {
            e.solutionLink = $("<a>").addClass("solution-link");
            e.solutionLinkText = $("<span>").addClass("link-text").text(a);
            e.solutionLink.append(e.solutionLinkText);
        }
        h.toggleText = e.isSolved ? d : b;
        $.post(Core.baseUrl + "/forum/topic/post/" + e.id + "/solution", {
            mark: !e.isSolved,
            xstoken: Cookie.read("xstoken")
        }).done(function(j, k, i) {
            e.containers.removeClass("is-solution").find(".solution-marker").remove();
            f.removeClass("is-solution").find(".button-right").text(d);
            if (!e.isSolved) {
                e.container.addClass("is-solution tsting-stuff");
                e.content.prepend(e.solutionMarker);
                h.addClass("is-solution").find(".button-right").text(h.toggleText);
            }
        }).fail(function(i, k, j) {});
    },
    openReportForm: function(c) {
        c = $(c);
        var a = c.data("post-id");
        var b = c.data("vote-type");
        var d = c.data("report-type");
        ReportPost.formWrapper.insertAfter($("#post-" + a)).show();
        $("#report-success").hide();
        $("#report-table").show();
        c.parents(".downvote-menu").hide();
        ReportPost.offensiveId.html(c.data("post-id"));
        ReportPost.offensiveAuthor.html(c.data("post-author"));
    },
    submitReport: function() {
        var a = ReportPost.offensiveId.html();
        var c = $("#report-detail").val();
        if (c === "") {
            Overlay.open(Msg.cms.validationError);
            return;
        }
        var b = Core.baseUrl;
        if (ReportPost.postType === "comments") {
            b += "/discussion/comment/";
        } else {
            b += "/forum/topic/post/";
        }
        b += (a + "/report");
        $.ajax({
            type: "POST",
            url: b,
            data: {
                type: $("#report-reason").val(),
                reason: c,
                xstoken: Cookie.read("xstoken")
            },
            success: function(d) {
                $("#report-success").show();
                $("#report-table").hide();
                ReportPost.offensiveId.html("");
                ReportPost.offensiveAuthor.html("");
            },
            error: function(f, d, e) {
                Overlay.open(f.statusText);
            }
        });
    },
    cancelReport: function() {
        ReportPost.formWrapper.hide();
        ReportPost.offensiveId.html("");
        ReportPost.offensiveAuthor.html("");
        if (ReportPost.postType === "comments") {
            ReportPost.formWrapper.insertAfter("#comments");
        } else {
            ReportPost.formWrapper.insertAfter("#post-list");
        }
    },
    ignoreUser: function(e, f, a) {
        e = $(e);
        e.parents(".ui-context").hide();
        var d = Cookie.read("bnetUserIgnore");
        d = (d != null) ? decodeURIComponent(d).split(",") : [];
        var b = $.inArray(f.toString(), d);
        var c = false;
        if (a) {
            if (b > -1) {
                d.splice(b, 1);
                c = ReportPost.updateIgnoreList(d);
            } else {
                Overlay.open(Msg.cms.ignoreNot);
            }
        } else {
            if (b < 0) {
                d.push(f);
                if (d.length > 100) {
                    d.shift();
                }
                c = ReportPost.updateIgnoreList(d);
            } else {
                Overlay.open(Msg.cms.ignoreAlready);
            }
        } if (c) {
            window.location.reload();
        }
    },
    updateIgnoreList: function(a) {
        Cookie.create("bnetUserIgnore", encodeURIComponent(a.join(",")), {
            path: Core.baseUrl,
            expires: 8760
        });
        return true;
    }
};
"use strict";
var Station = {
    wrapper: null,
    scrollContainer: null,
    scrollContainerWidth: 0,
    leftOffset: 0,
    currentOffset: 0,
    pagingWidth: 0,
    arrowPrev: null,
    arrowNext: null,
    initialize: function() {
        var c = $("#blizz-tracker-lite"),
            b = $(document),
            a = $("#tracker-scroll-container");
        Station.wrapper = c;
        Station.scrollContainer = a;
        Station.leftOffset = parseFloat(a.css("left"));
        Station.pagingWidth = parseFloat(a.find(".set:first").css("width"));
        Station.scrollContainerWidth = Station.pagingWidth * $(".set", a).length;
        Station.lastPageOffset = Station.scrollContainerWidth - Station.pagingWidth -
        Station.leftOffset;
        Station.currentOffset = Station.leftOffset;
        a.css("width", Station.scrollContainerWidth + Station.leftOffset);
        Station.arrowNext = $(".arrow-right", c);
        Station.arrowPrev = $(".arrow-left", c);
        Station.arrowNext.live("click", Station.next);
        Station.arrowPrev.live("click", Station.previous);
        $.ajax({
            url: Core.baseUrl + "/sidebar/forums?showTitle=false",
            type: "GET",
            dataType: "html",
            success: function(d) {
                $("#popular-topics-inner").html(d);
            }
        });
    },
    next: function(a) {
        a.preventDefault();
        a.stopPropagation();
        var b = Station.currentOffset - Station.pagingWidth;
        if (Math.abs(b) <= Station.lastPageOffset) {
            if (Math.abs(b) === Station.lastPageOffset) {
                Station.arrowNext.fadeOut();
            }
            Station.arrowPrev.fadeIn();
            Station._scrollTracker(b);
        } else {
            Station.arrowNext.fadeOut();
        }
    },
    previous: function(a) {
        a.preventDefault();
        a.stopPropagation();
        var b = Station.currentOffset + Station.pagingWidth;
        if (b <= Station.leftOffset) {
            Station.arrowNext.fadeIn();
            if (b === Station.leftOffset) {
                Station.arrowPrev.fadeOut();
            }
            Station._scrollTracker(b);
        } else {
            Station.arrowPrev.fadeOut();
        }
    },
    _scrollTracker: function(a) {
        Station.currentOffset = a;
        Station.scrollContainer.stop().animate({
            left: a + "px"
        });
    },
    toggleForumGroup: function(b, c) {
        var d = Cookie.read("forumParentToggle");
        d = (d != null) ? decodeURIComponent(d).split(",") : [];
        var a = $.inArray(b, d);
        if (a > -1) {
            d.splice(a, 1);
        } else {
            d.push(b);
        }
        Cookie.create("forumParentToggle", encodeURIComponent(d.join(",")), {
            path: Core.baseUrl + "/forum/",
            expires: 8760
        });
        $("#child" + b).slideToggle();
        $(c).toggleClass("collapsed").blur();
    }
};
var ForumTopic = {
    cachedQuotes: [],
    topicWrapper: null,
    replyFormWrapper: null,
    initialize: function(e, a, c, d, b) {
        ForumTopic.topicWrapper = $(e);
        ForumTopic.bindEvents(a, c, d);
        ForumTopic.storeTopicData(a, c, b);
    },
    bindEvents: function(a, b, c) {
        if (typeof a !== "undefined") {
            Cookie.erase("visitedThread", {
                path: Core.baseUrl + "/forum/" + a + "/"
            });
            ForumTopic.markRead(a, b, c);
        }
        if (Core.loggedIn) {
            ForumTopic.replyFormWrapper = $("#new-post");
            ForumTopic.replyFormWrapper.bind("submit", function() {
                ForumTopic.submitPost(this);
            });
            $(".preview-post", ForumTopic.replyFormWrapper).bind("click", function() {
                ForumTopic.previewPost(this);
            });
            $(".edit-post", ForumTopic.replyFormWrapper).bind("click", function() {
                ForumTopic.resumeEditPost(this);
            });
            $(".quote-post", ForumTopic.topicWrapper).bind("click", function() {
                ForumTopic.quoteTopic(this);
            });
            if ($("#post-countdown").length == 1) {
                ForumTopic.showCountDown();
            }
        }
    },
    storeTopicData: function(b, d, e) {
        var a = "forum." + b,
            c = Satchel.get("forum." + b) || {};
        c.topic = c.topic || {};
        c.topic[d] = c.topic[d] || {};
        c.topic[d].lastSeen = new Date().getTime();
        c.topic[d].replies = e;
        return Satchel.set(a, c);
    },
    markRead: function(b, e, f) {
        var d = Cookie.read("visitedThread");
        d = (d != null) ? decodeURIComponent(d).split(",") : [];
        var c = new Date;
        c = c.getTime();
        var g = false;
        for (var a in d) {
            d[a] = d[a].split("//");
            if (d[a][0] === e) {
                d[a][1] = c;
                d[a][2] = (!d[a][2] || d[a][2] < f) ? f : d[a][2];
                g = true;
            }
        }
        if (!g) {
            d.push([e, c, f]);
        }
        for (a in d) {
            d[a] = d[a].join("//");
        }
        if (d.length > 80) {
            d.shift();
        }
        Cookie.create("visitedThread", encodeURIComponent(d.join(",")), {
            path: Core.baseUrl + "/forum",
            expires: 8760
        });
    },
    deletePost: function(a, b) {
        if (!confirm(b)) {
            return false;
        }
        $.ajax({
            url: Core.baseUrl + "/forum/topic/post/" + a + "/delete",
            type: "POST",
            data: {
                xstoken: Cookie.read("xstoken")
            },
            dataType: "json",
            success: function(c) {
                if (c.errorMessage) {
                    Overlay.open(c.errorMessage);
                } else {
                    if (c.status == "postDeleted") {
                        var d = "/forum/topic/" + c.topicId + "?page=" + (c.page || 1);
                        if (c.anchor != 0) {
                            d += "#" + c.anchor;
                        }
                        location.href.replace(d);
                        location.reload(true);
                    } else {
                        if (c.status == "topicDeleted") {
                            Core.goTo("/forum/" + c.forumId + "/", true);
                        }
                    }
                }
            },
            error: function(c) {
                Overlay.open(c.statusText);
            }
        });
        return true;
    },
    undeletePost: function(a, b) {
        if (!confirm(b)) {
            return false;
        }
        $.ajax({
            url: Core.baseUrl + "/forum/topic/post/" + a + "/undelete",
            type: "POST",
            data: {
                xstoken: Cookie.read("xstoken")
            },
            dataType: "json",
            success: function(c) {
                if (c.errorMessage) {
                    Overlay.open(c.errorMessage);
                } else {
                    if (c.status == "postUndeleted") {
                        var d = "/forum/topic/" + c.topicId + "?page=" + (c.page || 1);
                        if (c.anchor != 0) {
                            d += "#" + c.anchor;
                        }
                        location.href.replace(d);
                        location.reload(true);
                    }
                }
            },
            error: function(c) {
                Overlay.open(c.statusText);
            }
        });
        return true;
    },
    toggleFreezePost: function(a, b) {
        if (!confirm(b)) {
            return false;
        }
        $.ajax({
            url: Core.baseUrl + "/forum/topic/post/" + a + "/toggleFreeze",
            type: "POST",
            data: {
                xstoken: Cookie.read("xstoken")
            },
            dataType: "json",
            success: function(c) {
                if (c.errorMessage) {
                    Overlay.open(c.errorMessage);
                } else {
                    if (c.status == "postFreezeToggled") {
                        var d = "/forum/topic/" + c.topicId + "?page=" + (c.page || 1);
                        if (c.anchor != 0) {
                            d += "#" + c.anchor;
                        }
                        location.href.replace(d);
                        location.reload(true);
                    }
                }
            },
            error: function(c) {
                Overlay.open(c.statusText);
            }
        });
        return true;
    },
    toggleHidePost: function(a, b) {
        if (!confirm(b)) {
            return false;
        }
        $.ajax({
            url: Core.baseUrl + "/forum/topic/post/" + a + "/toggleHide",
            type: "POST",
            data: {
                xstoken: Cookie.read("xstoken")
            },
            dataType: "json",
            success: function(c) {
                if (c.errorMessage) {
                    Overlay.open(c.errorMessage);
                } else {
                    if (c.status == "postHideToggled") {
                        var d = "/forum/topic/" + c.topicId + "?page=" + (c.page || 1);
                        if (c.anchor != 0) {
                            d += "#" + c.anchor;
                        }
                        location.href.replace(d);
                        location.reload(true);
                    }
                }
            },
            error: function(c) {
                Overlay.open(c.statusText);
            }
        });
        return true;
    },
    quoteTopic: function(b) {
        b = $(b);
        var a = b.data("post-id");
        var PostHTML = $('#post-text-id'+a).html();
        PostHTML = PostHTML.replace(/</g, '[').replace(/>/g, ']').replace(/\s+/g, " ");
        FinalHTML = '[quote="'+a+'"]' + PostHTML + '[/quote]';
        $("textarea#commentTextArea").html(FinalHTML);
    },
    resumeEditPost: function(c) {
        c = $(c);
        $(".preview-post", ForumTopic.replyFormWrapper).removeClass("selected");
        if (c.hasClass("selected")) {
            return false;
        }
        c.addClass("selected");
        var b = $("#post-preview");
        var a = $("#post-edit");
        b.hide();
        $("textarea", a).show();
    },
    previewPost: function(c) {
        c = $(c);
        $(".edit-post", ForumTopic.replyFormWrapper).removeClass("selected");
        if (c.hasClass("selected")) {
            return false;
        }
        c.addClass("selected");
        var b = $("#post-preview");
        var a = $("#post-edit");
        b.empty();
        BML.preview(a.find("textarea").val(), b, function() {
            $("textarea", a).hide();
            b.show();
        });
    },
    showCountDown: function() {
        var a = $("#post-countdown");
        var b = a.data("time-left") * 1000;
        $("button[type=submit]", ForumTopic.replyFormWrapper).hide();
        window.setTimeout(function() {
            ForumTopic.updateTimer("#post-countdown", ".time-left-display", b);
        }, 1000);
    },
    updateTimer: function(c, b, d) {
        var a = $(c);
        if (d > 0) {
            var d = d - 1000;
            $(b, a).html(Math.ceil(d / 1000));
            window.setTimeout(function() {
                ForumTopic.updateTimer(c, b, d);
            }, 1000);
        } else {
            $("button[type=submit]", ForumTopic.replyFormWrapper).show();
            a.hide();
        }
    },
    submitPost: function(c) {
        c = $(c);
        var f = c.serializeArray();
        var d = [];
        var e = c.data("max-post-length") * 1;
        for (var i = 0; i < f.length; i++) {
            if (f[i]["name"] === "detail") {
                var a = f[i]["value"];
                if (a.length > e) {
                    d.push(Msg.cms.characterExceed.replace("XXXXXX", e));
                }
            }
            if (f[i]["value"] == "" && f[i]["name"] != "pollId") {
                d.push(Msg.cms.validationError);
                break;
            }
        }
        var g = $("#post-errors");
        g.empty();
        if (d.length > 0) {
            var b = $("<ul />").appendTo(g);
            for (var h = 0; h < d.length; h++) {
                $("<li />").html(d[h]).appendTo(b);
            }
            return false;
        } else {
            return true;
        }
    },
    requestSticky: function(b, a) {
        if ($(b).hasClass("disabled")) {
            return;
        }
        $.ajax({
            type: "POST",
            url: Core.baseUrl + "/forum/topic/" + a + "/report",
            data: {
                type: "STICKY_REQUEST",
                reason: " ",
                xstoken: Cookie.read("xstoken")
            },
            global: false,
            success: function(c) {
                $(b).addClass("disabled");
                Overlay.open(Msg.cms.stickyRequested);
            },
            error: function(c) {
                if (c.errorMessage) {
                    Overlay.open(c.errorMessage);
                } else {
                    Overlay.open(Msg.ui.unexpectedError);
                }
            }
        });
    }
};
var Satchel = {
    isSupported: false,
    get: function _get(a) {
        if (Satchel.isSupported && a) {
            var b = localStorage.getItem(a);
            try {
                return JSON.parse(b);
            } catch (c) {
                return b;
            }
        }
        return null;
    },
    getAll: function _getAll(e) {
        var b = [];
        if (!Satchel.isSupported) {
            return b;
        }
        for (var c = 0, a = localStorage.length, d = null; c < a; c++) {
            d = localStorage.key(c);
            if (e && d.indexOf(e) !== 0) {
                continue;
            }
            b.push({
                key: d,
                value: Satchel.get(d)
            });
        }
        return b;
    },
    getKeys: function _getKeys(d) {
        var e = [];
        if (!Satchel.isSupported) {
            return e;
        }
        for (var b = 0, a = localStorage.length, c = null; b < a; b++) {
            c = localStorage.key(b);
            if (d && c.indexOf(d) !== 0) {
                continue;
            }
            e.push(c);
        }
        return e;
    },
    hasKey: function _hasKey(a) {
        if (Satchel.isSupported && a) {
            return (localStorage.getItem(a) && true) || false;
        }
        return false;
    },
    set: function _set(a, b) {
        if (Satchel.isSupported && a) {
            try {
                localStorage.setItem(a, JSON.stringify(b || ""));
            } catch (c) {
                return false;
            }
            return true;
        }
        return false;
    },
    remove: function _remove(a) {
        if (Satchel.isSupported && a) {
            localStorage.removeItem(a);
            return true;
        }
        return false;
    },
    clear: function _clear() {
        if (Satchel.isSupported) {
            localStorage.clear();
            return true;
        }
        return false;
    },
    size: function _size(a) {
        if (Satchel.isSupported && a) {
            return Satchel.getAll(a).length;
        }
        return localStorage.length || 0;
    }
};
(function() {
    if (window.localStorage) {
        Satchel.isSupported = true;
    }
})();
"use strict";
var Slideshow = {
    object: null,
    timer: null,
    index: 0,
    data: [],
    slides: [],
    playing: false,
    lastSlide: null,
    initialize: function(a, d) {
        Slideshow.object = $(a);
        Slideshow.data = d;
        Slideshow.slides = Slideshow.object.find(".slide");
        Slideshow.object.find(".mask").hover(function() {
            Slideshow.pause();
        }, function() {
            Slideshow.play();
        });
        Slideshow.object.find(".paging a").mouseleave(function() {
            Slideshow.object.find(".preview").empty().hide();
        });
        if (Slideshow.data.length > 0 && Slideshow.data[0].id) {
            var c = Slideshow.data[0].id;
            var b = Cookie.read("slideViewed");
            if (!b) {
                b = [];
            } else {
                b = decodeURIComponent(b).split(",");
            } if ($.inArray(c.toString(), b) < 0) {
                b.push(c);
            }
            if (b.length > 100) {
                b.shift();
            }
            Cookie.create("slideViewed", b.join(","), {
                escape: true,
                expires: 744
            });
        }
        if (Slideshow.slides.length <= 1) {
            Slideshow.object.find(".controls, .paging").hide();
        }
        Slideshow.link(0);
        Slideshow.play();
    },
    fade: function(b) {
        Slideshow.slides.stop(true, true).fadeOut("normal");
        Slideshow.slides.eq(b).fadeIn(1500);
        Slideshow.link(b);
        var a = Slideshow.object.find(".caption");
        a.stop(true, true).fadeOut("fast", function() {
            if (Slideshow.data[b]) {
                a.html("").append('<h3><a href="' + Slideshow.data[b].url +
                '" class="link">' + Slideshow.data[b].title + "</a></h3>").append(
                    Slideshow.data[b].desc).fadeIn(1500);
            }
        });
        Slideshow.lastSlide = b;
    },
    jump: function(a, b) {
        if ((Slideshow.lastSlide === a) || (Slideshow.slides.length <= 1)) {
            return;
        }
        Slideshow.pause();
        Slideshow.fade(a);
        Slideshow.index = a;
    },
    next: function() {
        var a = (Slideshow.data[Slideshow.index + 1]) ? Slideshow.index + 1 : 0;
        Slideshow.jump(a);
    },
    prev: function() {
        var a = (Slideshow.index - 1 >= 0) ? Slideshow.index - 1 : Slideshow.data.length -
        1;
        Slideshow.jump(a);
    },
    link: function(a) {
        if (Slideshow.data[a]) {
            Slideshow.object.find(".mask").unbind("click.slideshow").bind(
                "click.slideshow", function() {
                    if (typeof _gaq !== "undefined") {
                        var b = ["_trackEvent", Core.project + " Banners",
                            "Banner Click-Throughs", "Banner-" + Slideshow.data[a].id + "-" +
                            encodeURIComponent(Slideshow.data[a].title.replace(" ", "_")) + "-" +
                            Core.locale
                        ];
                        _gaq.push(b);
                    }
                    Core.goTo(Slideshow.data[a].url);
                }).end().find(".link").attr("href", Slideshow.data[a].url).end();
        }
    },
    play: function() {
        if (Slideshow.slides.length <= 1) {
            return;
        }
        if (!Slideshow.playing) {
            Slideshow.playing = true;
            Slideshow.timer = window.setTimeout(Slideshow.rotate, (Slideshow.data[
                Slideshow.index].duration * 1000) || 5000);
        }
    },
    pause: function() {
        if (Slideshow.slides.length <= 1) {
            return;
        }
        window.clearTimeout(Slideshow.timer);
        Slideshow.playing = false;
    },
    preview: function(a) {
        if (Slideshow.data[a]) {
            var b = Slideshow.object.find(".preview"),
                c = (a * 15) + 15;
            if (Slideshow.data[a].image) {
                $("<img/>", {
                    src: Slideshow.data[a].image,
                    width: 100,
                    height: 47,
                    alt: ""
                }).appendTo(b);
            }
            b.append("<span>" + Slideshow.data[a].title + "</span>").css("top", c);
            b.show();
        }
    },
    rotate: function() {
        var a = Slideshow.index + 1;
        if (a > (Slideshow.slides.length - 1)) {
            a = 0;
        }
        if (Slideshow.lastSlide === a) {
            return;
        }
        Slideshow.pause();
        Slideshow.fade(a);
        Slideshow.index = a;
        Slideshow.play();
        Slideshow.object.find(".paging a").removeClass("current").end().find(
            ".paging a:eq(" + a + ")").addClass("current");
    },
    toggle: function() {
        if (Slideshow.playing) {
            Slideshow.pause();
        } else {
            Slideshow.play();
        }
    }
};
var cmsAdmin = {
    $admin: "#cms-page-admin",
    $button: ".button",
    $menu: ".menu",
    toggleStateCookie: "cms.admin.ui.open",
    initialize: function() {
        this.$admin = $(this.$admin);
        this.$button = $(this.$button, this.$admin);
        this.$menu = $(this.$menu, this.$admin);
        this.$button.on("click", this.toggleMenu);
        this.$menu.on("click", "h1", this.toggleMenu);
    },
    toggleMenu: function() {
        if (cmsAdmin.$menu.is(":visible")) {
            cmsAdmin.$menu.hide();
            cmsAdmin.$button.show();
            cmsAdmin.saveMenuToggleState(false);
        } else {
            cmsAdmin.$menu.show();
            cmsAdmin.$button.hide();
            cmsAdmin.saveMenuToggleState(true);
        }
    },
    saveMenuToggleState: function(a) {
        Cookie.create(cmsAdmin.toggleStateCookie, a, {
            expires: 8760,
            path: "/"
        });
    },
    isMenuOpen: function() {
        return Cookie.read(cmsAdmin.toggleStateCookie);
    }
};
var PatchNotes = {
    init: function() {
        PatchNotes.createTOC();
    },
    createTOC: function() {
        var a = $(".table-of-contents"),
            b = $(".patch-contents h3");
        if (!a.length) {
            return;
        }
        if (!b.length) {
            return a.hide();
        }
        b.each(function() {
            var c = $(this),
                e = c.clone().children().remove().end().text().trim(),
                d = c.attr("id") || c.parent().parent().attr("name");
            a.append($("<a/>", {
                href: "#" + d,
                "class": "toc-link",
                text: e
            }));
        });
    }
};
var Poll = {
    init: function() {
        var a = parseInt($("#cms-poll").data("max-checked"));
        if (a != 0) {
            $("#cms-poll input:checkbox").on("click", function(c) {
                var b = $("#cms-poll input:checked").length;
                if (b > a) {
                    c.preventDefault();
                }
            });
        }
    },
    toggle: function(a, c, d) {
        var b = $(a);
        if (b.hasClass("selected") && c === "poll-options") {
            Poll.vote(d);
        }
        $("#poll-container ." + c).show().siblings("div").hide();
        b.addClass("selected").siblings().removeClass("selected");
    },
    vote: function(b) {
        var a = [];
        $("#poll-container input:checked").each(function() {
            a.push(this.value);
        });
        if (a.length === 0) {
            return;
        }
        $.ajax({
            type: "POST",
            url: Core.baseUrl + "/forum/topic/poll/" + b + "/vote",
            data: "selection=" + a.join("&selection=") + "&xstoken=" + Cookie.read(
                "xstoken"),
            success: function() {
                location.reload();
            }
        });
    }
};
var SearchPane = {
    searchUrl: "/search/json",
    defaultDisplayType: "article",
    dataType: "jsonp",
    defaultResultListElementClass: "search-pane-result-list",
    load: function(e, d, c) {
        var b = SearchPane.defaultDisplayType,
            a = $(e),
            f = c;
        if (!f) {
            f = SearchPane.defaultRenderFunction;
        }
        if (d.type) {
            b = d.type;
        }
        $.ajax({
            type: "GET",
            url: jsonSearchHandlerUrl + "/" + Core.language + SearchPane.searchUrl,
            dataType: SearchPane.dataType,
            async: true,
            cache: true,
            data: {
                q: d.query,
                f: d.type,
                a: d.author,
                r: d.results,
                k: d.keyword,
                community: d.community,
                sort: d.sortBy,
                dir: d.sortOrder
            },
            success: function(g) {
                a.html(f(g, b));
            },
            error: function(g) {
                a.text(Msg.ui.unexpectedError);
            }
        });
    },
    defaultRenderFunction: function(c, d) {
        var g = c.results[d],
            b = $("<ul/>");
        b.attr("class", SearchPane.defaultResultListElementClass);
        if (!g) {
            b = $("<div/>");
            b.text(Msg.search.noResults);
        } else {
            for (var e = 0; e < g.length; e++) {
                var a = $("<li/>");
                var f = $("<a/>");
                f.attr("href", g[e].url);
                f.text(g[e].title);
                a.append(f);
                b.append(a);
            }
        }
        return b;
    }
};
var Search = {
    ta: null,
    map: {
        articlekeyword: "article",
        blog: "article",
        product: "product",
        "static": "static",
        friend: "friend"
    },
    initialize: function(b, c) {
        var a = [];
        if (Core.project === "wow") {
            a = ["friend", "url", "wowcharacter", "wowguild", "wowarenateam",
                "wowitem", "article", "static", "other"
            ];
            Search.map.character = "wowcharacter";
            Search.map.arenateam = "wowarenateam";
            Search.map.guild = "wowguild";
            Search.map.wowitem = "wowitem";
            Search.map.item = "wowitem";
            Search.map.friend = "wowcharacter";
        } else {
            a = ["friend", "url", "product", "article", "static", "other", "kb"];
        }
        Search.ta = TypeAhead.factory(c || "#search-field", {
            groupResults: true,
            resultTypes: a,
            ghostQuery: (Core.region === "us" || Core.region === "eu" || Core.region ===
            "sea"),
            source: function(d, e) {
                $.ajax({
                    url: b,
                    data: {
                        term: d,
                        locale: Core.formatLocale(2, "_"),
                        community: Core.project
                    },
                    cache: true,
                    dataType: b.charAt(0) === "/" ? "json" : "jsonp",
                    success: function(h) {
                        var k = [];
                        if (h.results) {
                            for (var j = 0, g; g = h.results[j]; j++) {
                                var m = "",
                                    f = $("<div/>").html(g.title || g.term);
                                if (f) {
                                    m = f.text();
                                }
                                var l = {
                                    type: Search.map[g.type] || "url",
                                    title: m,
                                    desc: "",
                                    url: "",
                                    icon: ""
                                };
                                switch (g.type) {
                                    case "character":
                                        l.desc = g.realmName;
                                        l.url = Core.baseUrl + "/character/" + g.realmName.replace(
                                            /[^a-z0-9]/ig, "-").toLowerCase() + "/" + g.term + "/";
                                        break;
                                    case "arenateam":
                                        l.desc = g.realmName;
                                        l.url = Core.baseUrl + "/arena/" + g.realmName.replace(
                                            /[^a-z0-9]/ig, "-").toLowerCase() + "/" + g.teamSize + "/" +
                                        g.term + "/";
                                        break;
                                    case "guild":
                                        l.desc = g.realmName;
                                        l.url = Core.baseUrl + "/guild/" + g.realmName.replace(
                                            /[^a-z0-9]/ig, "-").toLowerCase() + "/" + g.term + "/";
                                        break;
                                    case "wowitem":
                                    case "item":
                                        l.className = "color-q" + g.rarity;
                                        l.desc = Core.msg(Msg.cms.ilvl, g.level);
                                        l.url = Core.baseUrl + "/item/" + g.objectId;
                                        if (g.context) {
                                            l.url += "/" + g.context;
                                        }
                                        break;
                                    case "url":
                                    case "static":
                                    case "product":
                                        l.desc = g.desc;
                                        l.icon = g.icon;
                                        l.url = g.url;
                                        break;
                                    case "friend":
                                        l.url = Core.projectUrl + g.url;
                                        l.icon = Core.projectUrl + g.icon;
                                        break;
                                    default:
                                        l.url = "";
                                        if (g.url) {
                                            l.url = $("<div/>").html(g.url).text();
                                        }
                                        if (l.title !== g.term) {
                                            l.desc = g.term || "";
                                        }
                                        break;
                                }
                                k.push(l);
                            }
                        }
                        e(k);
                    }
                });
            }
        });
    }
};
var Sidebar = {
    totalModules: 0,
    totalLoaded: 0,
    modules: [],
    forceLoad: true,
    sidebar: function(a) {
        Sidebar.totalModules = a.length;
        if (a.length) {
            for (var b = 0; b <= (a.length - 1); ++b) {
                Sidebar.loadModule(a[b], b);
            }
        }
        window.setTimeout(function() {
            if (Sidebar.forceLoad) {
                Sidebar.showSidebar();
            }
        }, 5000);
    },
    showSidebar: function() {
        Sidebar.forceLoad = false;
        var a = $("#dynamic-sidebar-target");
        var c = $("#sidebar .sidebar-bot");
        for (var b = 0; b < Sidebar.totalModules; b++) {
            if (Sidebar.modules[b]) {
                Sidebar.modules[b].appendTo(a);
            }
        }
        $("#sidebar-loading").fadeOut("normal", function() {
            c.find(".sidebar-module").fadeIn();
            $(this).remove();
        });
        Sidebar.modules = [];
        Sidebar.totalModules = 0;
        Sidebar.totalLoaded = 0;
    },
    loadModule: function(c, b) {
        var a = $("#dynamic-sidebar-target");
        $.ajax({
            url: "/pager.php?category=sidebar&subcategory="+c.type,
            type: "GET",
            cache: true,
            global: false,
            success: function(e) {
                Sidebar.totalLoaded++;
                if ($.trim(e) !== "") {
                    var d = $(e);
                    if (Sidebar.forceLoad) {
                        d.hide();
                        Sidebar.modules[b] = d;
                    } else {
                        d.appendTo(a);
                    }
                }
            },
            error: function() {
                Sidebar.totalLoaded++;
            },
            complete: function() {
                if (Sidebar.totalLoaded >= Sidebar.totalModules) {
                    window.setTimeout(Sidebar.showSidebar, 100);
                }
            }
        });
    }
};